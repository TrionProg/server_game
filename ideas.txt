кто обрабатывает коллизионы пуль
как обрабатывать коллизионы снарядов, в каком порядке
как обрабатывать коллизионы игроков, как их контроллировать, как и когда оповещать других о направлении движения других игроков
кто обрабатывает скрипты, и как их обрабатывать для максимальной гладкости
  (по логике это надо делать и на стороне клиента с той же скоростью, а при некоторых нарушениях, передвигать и тд, но тогда может сбиться программа, хотя
  можно изаставить пройти по опред ветке заново)
как работает оружие? в основном все должно работать на расте, а скрипты как дополнение
как и когда отсылать чанки? жел-но отсылать их полосами, но и по спирали, причем если серв не нагружен очень сильно, то отсылать наиболее далекие чанки
как обрабатывать машины в тч с АI?
  ну как праивило поведение клиента будет копировать сервера,но все равно будут траблы некоторые, например у клиента враг виден и турель выстрелила, а на сервере нет
как обрабатывать здания, их разрушения и тд?

думаю, что нужно сделать несколько воркеров, и несколько пуллов с заданиями, событиями в скриптах. Воркеры не должны вызвать дедлок никогда.
Внимание:действия юзеров могут нарушить события в скриптах.
Принцип работы:
сначала, например, connection, прочитав пакет в буфер, анализирует заголовок(u32), и либо выполняет его(логин, disconnection), либо пушит в пулл(disconnection тоже пушится, чтобы удалить игрока?)
пушит в пулл декодированный пакет, или копию из буфера(тогда и не надо писать в буфер?) Но не все нужно так обрабатывать. например, движения игрока
затем воркер берет задание, переводит в пакет, анализирует и исполняет. однако все-таки надо сортировать пакеты и задания по времени, чтобы не было всяких хреней.
и да, время в пакете от игрока должно быть большим, чем временем предыдущего пакета.
может для чанков выделить отдельный поток, который и будет СИНХРОННО насиловать жесткий. Интересно, а как SSD относится к ассинхронизации? тогда же можно плавно и размеренно посылать
игроку чанки
представим, что игроку отправили чанк, но он не отправился, то все-таки потом сначала отправится именно этот чанк, а лишь потом история его изменений

move(pitch,yaw,speed) speed=0 значит, что он озирается
shot(pitch,yaw,...параметры)

на стороне клиента тоже должна быть очередь событий, отправленных серверу, сортированная по времени, при приходе ответа от сервера, на сообщение, удаляем все до этого сообщения.
однако надо быть настороже с позицией игроков
оповещать периодически, а не сразу всех.
анимация других игроков на основе уже пришедших пакетов.
а вот статические объекты разрушаются так:как бы сейчас, (сервер врядли скажет "упс, разрушать здание не надо"). А что, если в одно место выстрелили несколькьо игроков
сначала мы дескать пробили дыру, а потом оказывается, что там уже была дыра, мы не попали и здание не пострадало? во всяком случае из-за дыма можно спокойно подождать 500мс, а дым был дескать другого игрока
восстанавливать здание после разрушения очень сложно и будет выглядеть странным, а вот его разрушение весьма медленное.
а что если здание разрушилось, а выстрел был n-е время назад? и тогда игрок должен бы выжить? Ну это редкий случай, + вряд ли он не погибнет при разрушении =))

Это КЛЮЧЕВОЙ момент. Так как сервер все равно рассылает свое состояние каждый кадр по клиентам, он может восстановить любой момент из прошлого. В том числе, он может восстановить мир в точности таким, каким его видел клиент в момент выстрела.
именно кадр. хотя  у меня и не весь мир, а лишь некоторые чанки. оптимальнее же

как быть игрок стреляет по другому, а он вот подлечился.. но тк это ж в прошлом, игрок тогда 100% не подличился же. пофикшено

После логина
после логина юзера ему предоставляется список нужных модов с указанием версий(кэшируются только zip-ы как завершенные модули) и в ответ юзер отправляет список модово, которые он хочет получить.
сервер отправляет некышируемые моды, но моды, которых нет у юзера и котрые кэшируемы, можно отправить либо серверу, либо пусть клиент качает их из репозиториев, список которых сервер предоставит
далекие чанки можно отправлять и так-
сначала тупо террайн, причем с учетом детализации, а потом уже качественные, с винта будут читаться конечно качественные. это позволит как можно скорее погрузить игрока в мир.
будет спец поток, который будет отпарвлять чанки, здания и тд
чанки грузятся не вокруг игрока, а вокруг камеры, тк оптический прицел ее приближает. максимум на 100-150 метров.


Позиция игрока
клиент: передаем 10 раз в секунду инфу о положении игрока, скорости, направлении (в тч shot)
сервер: если пакет новее, чем последний пришедший, то {
  исходя из этих данных проверяется погрешность с предсказаниями, основанных на предыдущих данных,
  если она высока, или игрок проходит сквозь стену(карта в реальном времени),(вот и проверим коллизионы, наверно линейно), то возвращаем игрока на место(спец пакет),
  иначе же соглашаемся и строим сплайн, который будет использоваться при коллизионах, отправляем другим игрокам новую позицию.
  }
клиент2: получаем данные и соединяем со старыми сплайном, поправки и ускорения/ замедления анимаций если запаздывают, опережают.
еще на основе загруженности будет расчитываться число, сколько пакетов в секунду, и если пакет приходит раньше интервала, то он не обрабатывается.
нужно ввести некий пароль сессии, чтобы другие не могли, подделав запрос, отправить ложные пакеты.
Для ближайшего игрока 3/3 пакетов, для среднего 2/3, для дальнего 1/3 с характерным растягивание(регулярно), либо можно 4/4 2/4 1/4
можно еще передавать эту и 2 предыдущих позиции дял компенсации потери пакетов

Выстрел
обязательно надо доставить, время так же важно. но надо сделать так, чтобы юзер не говорил что-т вроде "да я 3 секунду назад уже стрелял", хотя смысл так врать, если аимбот и так быстро рассчитает?
поэтому посылаем пакет о выстреле с временем пока не придет ответ "попал, не попал" с таким же временем, инфу о выстреле разослать другим игрокам, а вот корректность проверить чуток позже.
кстати из-за задержек может получиться так, что игроки могут убить друг друга "одновременно". Поскольку выстрелом будет много, можно завести отдельный поток bulletTrasser, и передевать ему задания по каналу с очередью
Интересно, как вовремя передать окончание стрельбы, ведь оно прийдет с запазданием, правда запаздание будет почти таким же, как и у начала стрельбы(хотя у UDP из-за разных маршрутов может что-то измениться).
Или по одному выстрелу(залагает) хотя можно "отменить" выстрелы, патроны можно вернуть, а вот "убитых невозможно".
можно еще рубить выстрелы на пачки по 5, и указывать лимит(хотя серв и так знает)
очереди и одиночные разные.
в очереди первый выстрел как из снайперки, остальные же сервер решает сам(рандом + позиция и другие факторы). ждем пакета о получении пакета. рубим по n выстрелов на основе темпа стрельбы. те для минигана 20, для ак-47 5
одиночные: ждем пакета о результате выстрела
для очередей храним кеш дольше
для одиночной реже(смотря на время перезарядки(полу-автомат), чтобы след выстрел попал бы когда кэш еще существовал бы)

еще хорошо после выстрела делать кэш старого мира - что пуля затронула, а в последующие выстрелы обновлять состояние по истории, причем сам кэш -- для автоматического оружия
а если выстрелы нескольких игроков? время все равно схожее, и надо делать, как проще, либо поднимать самое сстарое состояние, либо опускать новое.

>а что если у чанка хранить время изменения, и если они совпадают с кешем у игрока(те карта не менялась, например спаун), то не отправляем чанк.
очень, очень редко так будет, а чанк мало весит.


самые затратные операции:
(часто) обработака коллизионов(игроков и пуль, снарядов):надо читать хард, обрабатывать полигоны
(редко) разрушение зданий:надо обрабатывать геометрию и ломать
(редко) повреждение и раскрашивание террайна - много геометрии
(часто) подгрузка чанков, зданий:надо читать хард
(редко,но много)загрузка модов - надо читать хард
скрипты на корутинах, которые хз как выполнять, и когда.

!юзер может зарегаться на серве и таким образом зарегаться на главном сервере


инфу о положении игроков все-таки не так уж и сложно обработать(только геометрия, чанкои грузить практически не надо -- лишь если загрузчик чанков это не сделал), но ее важно ТУТ же всем разослать, так что думаю, пусть будет в потоке сервера
пакеты не являются важными - так или иначе с любой задержкой анимаия проиграется

n раз в секунду

1 тред на TCP каждый из них может удалять коннекшн, но как? как из очереди удалить например? или тупо через shouldReset?
1 тред на UDP
  на них обработка коллизионов игроков
1 тред на обработку выстрелов
1 тред на разрушения зданий, террайна.
  террайн разрушается 2хэтапно. 1) тупо heightmap(нужно для коллизионов, на стрельбу из оружия геометрия не влияет)
                                          2) в этом потоке меняется геометрия для отправки новым игрокам. внимание, такой чанк не отправлять!
  здания разрушаются поэтапно.  1) проделываем дыры, что нужно для последующих коллизионов(отправляем пакет и проделываем, посмотрим, как сложно будет)
                                          2) проверяем, рухнет ли здание. на самом деле редко
1 тред на обработку логики?
1 тред на подгрузку чанков
1 тред на чтение ввода с консоли. мб пусть он по таймауту и отсылает уведомления о активности?

если для коллизионов нужно состояние необработанного этапом 2 объекта, удаляем из очереди и разрушаем сами
идентификатор для UDP ip+user
item-ы будут храниться в связанных пуллах размером, например 1024 байта(внутри 8 на пред и след), а инвентарь представляет собой вектор указателей на это оружие
или оружие будет храниться в виде пуллов тупо [u8;lenght] - тк нельзя менять адрес оружия, а начит нельзя хранить в векторе, нужно хранить в пулле. хз как с синхронизацией
для событий ор-я нужно создать vtable:[function,items number]; инвентарь игрока - тупо список этих указателей, то, что в руке, так же казатель. первые 4 байта итема-индекс в vtable.
но как тогда сделать типа "выкинут итем такой(лучше ID)" ? может для итимов завести спец пул item-ов, которые будут иметь уже указатели. обращение к итимама редко и как правило их изменяет,так что
mutex или возможно rwlock..для всех. сама же data может быть тупо сишной, threadsafe ей не нужно тк все равно юзается редко,но все же жел-но как-нить в расте осуществить
вообще все должно быть по индексам и храниться в пуллах, а data отдельно, жел-но тоже в пуллах. можно юзать список слабов. а кол-во расчитывать на основе длиныданных и кол-ва.

интересно, а как быть с тем, что игрок бежит, а спустя секунду оказывается, что другой взорвал его. Имхо, игроку надо причинить демаж, но если он выживет, то получится, дескать снаряд упал позади и поцарапал

Player{
  id
  name,
  <something>
  inGame:None,Some{,
    mode:Ghost, Entity
    x,y,z,p,y,inventory,inhand
  }
}

Item{
  mode:clickPerShot, automatic, tool, toolCycle(бензопила)

  item может быть оружием и не оружием или например киркой.
}

с помощью скриптов можно
прописать, что делать во время выстрела
как во время "выстрела" разрушать что-то(кирка)
как строить
поведение ботов и машин
сам геймплей(на стороне сервера только)
интерфейс(в тч инвентарь)
поведения и ограничения на то, когда юзер что-то подбирает

эхх. и что же мне писать? видимо надо сначала TCP и UDP серверы. Все поля тупо обернуть мутексами - потом распределю.
потом логин
потом сонхронизация времени
потом список модов
докачка
если есть карта, то обрабатываем геймплей
нужно сгенерировать карту
